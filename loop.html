#!/usr/bin/env python3
import os
import sys
import subprocess
import argparse

COPYRIGHT = "Made with â™¥ by HUMN.audio 2025"


def loop_video(src: str, hours: int, minutes: int, out: str) -> None:
    """
    Loop a short video into a longer one using ffmpeg copy mode.
    """
    total_secs = hours * 3600 + minutes * 60
    if total_secs <= 0:
        print("Error: Total duration must be greater than zero.")
        sys.exit(1)
    ffmpeg_bin = os.path.join(sys._MEIPASS, "ffmpeg.exe") if getattr(sys, 'frozen', False) else "ffmpeg"
    cmd = [
        ffmpeg_bin,
        "-y", "-hide_banner", "-loglevel", "error",
        "-stream_loop", "-1",
        "-i", src,
        "-c", "copy",
        "-t", str(total_secs),
        out
    ]
    print(f"Running: {' '.join(cmd)}")
    try:
        subprocess.run(cmd, check=True)
        print(f"Done! Looped video saved to: {out}")
    except subprocess.CalledProcessError as e:
        print(f"FFmpeg error (code {e.returncode}): {e}")
        sys.exit(e.returncode)


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(
        description="Loop a short MP4 video into a longer clip by remuxing with ffmpeg."
    )
    parser.add_argument(
        "src",
        help="Path to the source MP4 video to loop"
    )
    parser.add_argument(
        "-H", "--hours",
        type=int,
        default=0,
        help="Hours part of target duration (default: 0)"
    )
    parser.add_argument(
        "-M", "--minutes",
        type=int,
        default=0,
        help="Minutes part of target duration (0-59, default: 0)"
    )
    parser.add_argument(
        "-o", "--output",
        help="Output filename (default: <base>_looped_<H>h<M>m.mp4)"
    )
    return parser.parse_args()


def main():
    args = parse_args()
    if not os.path.isfile(args.src):
        print(f"Error: Source file '{args.src}' not found.")
        sys.exit(1)
    # Determine default output name if not provided
    if args.output:
        out = args.output
    else:
        base = os.path.splitext(os.path.basename(args.src))[0]
        out = f"{base}_looped_{args.hours}h{args.minutes}m.mp4"
    loop_video(args.src, args.hours, args.minutes, out)


if __name__ == "__main__":
    print(COPYRIGHT)
    main()
